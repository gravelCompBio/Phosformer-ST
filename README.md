<!-- This Github was Made By Nathan Gravel and tested with help of Mariah Salcedo-->
# Phosformer-ST  <img src="https://github.com/gravelCompBio/Phosformer-ST/assets/75225868/f375e377-b639-4b8c-9792-6d8e5e9e6c39" width="60">

## Introduction  

  



  

This repository contains the code to run Phosformer-ST locally from the manuscript "**Phosformer-ST: explainable machine learning
uncovers the kinase-substrate interaction landscape**". This readme should also give you the specific versions for all packages used to run Phosformer-ST in a local environment.
The model was created by Zhongliang Zhou and Wayland Yeung. The Phos-ST webtool is found from this link (https://phosformer.netlify.app/) and was generated by Saber Soleymani. 

</br>
  
## Quick overview of the dependencies
![Python](https://img.shields.io/badge/Python-FFD43B?style=for-the-badge&logo=python&logoColor=blue)
![Anaconda](https://img.shields.io/badge/Anaconda-%2344A833.svg?style=for-the-badge&logo=anaconda&logoColor=white) 
![Jupyter](https://img.shields.io/badge/Jupyter-F37626.svg?&style=for-the-badge&logo=Jupyter&logoColor=white)
![PyTorch](https://img.shields.io/badge/PyTorch-EE4C2C?style=for-the-badge&logo=pytorch&logoColor=white)

![Numpy](https://img.shields.io/badge/Numpy-777BB4?style=for-the-badge&logo=numpy&logoColor=white)
![Pandas](https://img.shields.io/badge/Pandas-2C2D72?style=for-the-badge&logo=pandas&logoColor=white)
![Matplotlib](https://img.shields.io/badge/Matplotlib-%23ffffff.svg?style=for-the-badge&logo=Matplotlib&logoColor=black)
![scikit-learn](https://img.shields.io/badge/scikit--learn-%23F7931E.svg?style=for-the-badge&logo=scikit-learn&logoColor=white)

  
</br>


## Included in this repository are the following:  

  

- `phos-ST_Example_Code.ipynb`: Jupyter File with example code to run Phosformer-ST

- `modeling_esm.py`: Python file that has the architecture of Phosformer-ST

- `configuration_esm.py`: Python file that has configuration/parameters of Phosformer-ST 

- `tokenization_esm.py`: Python file that contains code for the tokenizer 


- `multitask_MHA_esm2_t30_150M_UR50D_neg_ratio_8+8_shift_30_mask_0.2_2023-03-25_90.txt`: this txt file contains a link to a zenodo repository to download the proper folder 

  - This folder holds the files that contained the training weights for Phosformer-ST to run as advertised
  - See section below (Downloading this repository) to be shown how to download this folder and where to put it

- `phosST.yml`: This file is use to help create an environment for Phos-ST to work
  
- `Readme.md`: You're reading it right now 

   

 </br>
 
 </br>

   

## Installing dependencies with version info   


### From conda:   

![python=3.9.16](https://img.shields.io/badge/Python-3.9.16-green) 

![jupyterlab=4.0.0](https://img.shields.io/badge/jupyterlab-4.0.0-blue) 

Python == 3.9.16 

  

### From pip: 

  

![numpy=1.24.3](https://img.shields.io/badge/numpy-1.24.3-blue) 

![pandas=2.0.2](https://img.shields.io/badge/pandas-2.0.2-blue) 

![matplotlib=3.7.1](https://img.shields.io/badge/matplotlib-3.7.1-blue) 

![scikit-learn=1.2.2](https://img.shields.io/badge/scikitlearn-1.2.2-blue) 

![tqdm=4.65.0](https://img.shields.io/badge/tqdm-4.64.1-blue)

![fair-esm=2.0.0](https://img.shields.io/pypi/v/fair-esm?label=fair-esm)  

![transformers=4.31.0](https://img.shields.io/badge/transformers-4.31.0-blue) 

![torch=2.0.1](https://img.shields.io/badge/torch-2.0.1-blue)     

 ### For torch/PyTorch
 
 Make sure you go to this website https://pytorch.org/get-started/locally/
 
 Follow along with its recommendation 
 
 Installing torch can be the most complex part 


 </br>

 

  
### The computer specs that we know that this model can run on (with gpu acceleration)

 </br>

**Computer 1**

Ubuntu 22.04.2 LTS

Intel(R) Xeon(R) Bronze 3204 CPU @ 1.90GHz  (6 cores) x (1 thread per core)

64 GB ram

NVIDIA Quadro RTX 5000 (16 GB vRAM)(CUDA Version: 12.1) 

 </br>

**Computer 2**

Ubuntu 20.04.6 LTS

Intel(R) Xeon(R) Bronze 3204 CPU @ 1.90GHz  (6 cores) x (1 thread per core)

64 GB ram

NVIDIA RTX A4000 (16 GB vRAM)(CUDA Version: 12.2) 



</br>

</br>

  

## Downloading this repository  

```  
gh repo clone gravelCompBio/Phos-ST-temp
```  

```  
cd Phos-ST-temp
```
### The following step uses zenodo becauase the folder is larger then the allowed space on github

Then download the link found in `multitask_MHA_esm2_t30_150M_UR50D_neg_ratio_8+8_shift_30_mask_0.2_2023-03-25_90.txt` or can be found at this link https://zenodo.org/record/8170005

The page should look like this


![Screenshot from 2023-07-20 18-14-19](https://github.com/gravelCompBio/Phos-ST-temp/assets/75225868/109c898e-49cc-4849-abb6-1dcb1f3aa5c1)




Click the download box highighted in picture above

Once downloaded, **unizip** the folder and place in the `Phos-ST-temp` along with all the other files in this github repository

The `Phos-ST-temp` folder should have the following files/folder in it

- file 1 `phos-ST_Example_Code.ipynb`

- file 2 `modeling_esm.py`
  
- file 3 `configuration_esm.py`

- file 4 `tokenization_esm.py`

- file 5 `multitask_MHA_esm2_t30_150M_UR50D_neg_ratio_8+8_shift_30_mask_0.2_2023-03-25_90.txt`

- file 6 `phosST.yml`
  
- file 7 `Readme.md`

- folder 1 `multitask_MHA_esm2_t30_150M_UR50D_neg_ratio_8+8_shift_30_mask_0.2_2023-03-25_90` (make sure it is unzipped)

:tada: Once you have a folder with the files/folder above in it you have done all the downloading needed :tada:


</br>

</br>

  

## ![Anaconda](https://img.shields.io/badge/Anaconda-%2344A833.svg?style=for-the-badge&logo=anaconda&logoColor=white) Installing dependencies with conda 

### PICK ONE of the options below 
### Option 1) Utilizing the PhosformerST.yml file
here is a step-by-step guide to set up the environment with the yml file 

Just type these lines of code into the terminal after you download this repository (this assumes you have anaconda already installed)

```  
conda env create -f phosST.yml -n PhosST 
```  
```  
conda deactivate
```  
```  
conda activate phosST 
```  

 ### Option 2) Creating this environment without yml file
(This is if torch is being weird with your version of cuda or any other problem)
Just type these lines of code into the terminal after you download this repository (this assumes you have anaconda already installed)
```  
conda create -n phosST python=3.9 
```
```  
conda deactivate
```
```  
conda activate phosST 
```
```  
conda install -c conda-forge jupyterlab
```
```  
pip3 install numpy==1.24.3
```
```  
pip3 install pandas==2.0.2
```
```  
pip3 install matplotlib==3.7.1
```
```  
pip3 install scikit-learn==1.2.2
```
```  
pip3 install tqdm==4.65.0
```
```  
pip3 install fair-esm==2.0.0
```
```  
pip3 install transformers==4.31.0
```
### **For torch you will have to download to the torch's specification if you want gpu acceleration from this website** https://pytorch.org/get-started/locally/

```  
pip3 install torch torchvision torchaudio
```

### the terminal line above might look different  for you 

We provided code to test Phos-ST (see section below)


</br>

</br>



## Utilizing the Model with our example
All the following code examples is done inside of the `phos-ST_Example_Code.ipynb` file using jupyter lab

Once you have your environment resolved just use jupyter lab to access the example code by typing the comand below in your terminal (when your in the `Phos-ST-temp` folder) 
```  
jupyter lab
```
Once you open the notebook on your browser, run each cell of notebook 

</br>

### Testing Phos-ST with the example code
There should be a positive control and a negative control example code at bottom of the `phos-ST_Example_Code.ipynb` file. This is here just to sanity check that the model is working. The positive and negative control is running the same code with known examples where Phos-ST should give an answered close to 1 (positive control) or 0 (negative control). 

**Positive Example**
```Python
# P17612 KAPCA_HUMAN
kinDomain="FERIKTLGTGSFGRVMLVKHKETGNHYAMKILDKQKVVKLKQIEHTLNEKRILQAVNFPFLVKLEFSFKDNSNLYMVMEYVPGGEMFSHLRRIGRFSEPHARFYAAQIVLTFEYLHSLDLIYRDLKPENLLIDQQGYIQVTDFGFAKRVKGRTWTLCGTPEYLAPEIILSKGYNKAVDWWALGVLIYEMAAGYPPFFADQPIQIYEKIVSGKVRFPSHFSSDLKDLLRNLLQVDLTKRFGNLKNGVNDIKNHKWF"
# P53602_S96_LARKRRNSRDGDPLP
substrate="LARKRRNSRDGDPLP"

phosST(kinDomain,substrate).to_csv('PostiveExample.csv')
```


**Negative Example**
```Python
# P17612 KAPCA_HUMAN
kinDomain="FERIKTLGTGSFGRVMLVKHKETGNHYAMKILDKQKVVKLKQIEHTLNEKRILQAVNFPFLVKLEFSFKDNSNLYMVMEYVPGGEMFSHLRRIGRFSEPHARFYAAQIVLTFEYLHSLDLIYRDLKPENLLIDQQGYIQVTDFGFAKRVKGRTWTLCGTPEYLAPEIILSKGYNKAVDWWALGVLIYEMAAGYPPFFADQPIQIYEKIVSGKVRFPSHFSSDLKDLLRNLLQVDLTKRFGNLKNGVNDIKNHKWF"
# Q01831_T169_PVEIEIETPEQAKTR
substrate="PVEIEIETPEQAKTR"

phosST(kinDomain,substrate).to_csv('NegitiveExample.csv')
```
Both scores should show up in a csv file in the same folder of this code

</br>

### Inputting your own data for novel predictions
One can simply take the code from above and modify the string variables `kinDomain` and `substrate` to your prediction of interest

**Formatting  of the `kinDomain` and `substrate` for input for phos-ST are as followed:**

  - `kinDomain` should just be the kinase domain (instead of the full sequence), preferably human, and a Serine/Threonine kinases  
    
  - `substrate` should be a 15mer with the center residue/char being the Serine or Threonine being phosphorylated

Not following these rules will still give you and output at time but does not guarantee a prediction with the accuracy advertised 


</br>

### How to interperate Phosformer-ST's output
This model was trained to use the cuttoff of 0.5 as the differnce between postive prediction and negetive prediction 

If the your custom prediction is above 0.5, the model is predicting the kinase-substrate pair is a postivite prediction for a phosforylation event 

Though becaseue the traing data is ultimently based on a positional scanning peptide array, this model only takes into account kianse binding preference.

So combinding with other spacial, temporal, or other biologiclly relevlent filters might be more accurate when modeling protein kinase.

</br>




### Modifying the code to take in a list of kinase domains and substrates
Currenly, we have it only predicting one kinase domain + one substrate at a time. One can simply swap out the `helper function to use Phos-ST` code-block with the code-block below. The input arguments now require a list of strings for both the kinase domains and substrates. Make sure the list of both kinases and substrates are the same length and conserve the same format specified in the "Inputting your own data for novel predictions" section of the readme 
```Python
# P17612 KAPCA_HUMAN listed twice
kinDomains=["FERIKTLGTGSFGRVMLVKHKETGNHYAMKILDKQKVVKLKQIEHTLNEKRILQAVNFPFLVKLEFSFKDNSNLYMVMEYVPGGEMFSHLRRIGRFSEPHARFYAAQIVLTFEYLHSLDLIYRDLKPENLLIDQQGYIQVTDFGFAKRVKGRTWTLCGTPEYLAPEIILSKGYNKAVDWWALGVLIYEMAAGYPPFFADQPIQIYEKIVSGKVRFPSHFSSDLKDLLRNLLQVDLTKRFGNLKNGVNDIKNHKWF","FERIKTLGTGSFGRVMLVKHKETGNHYAMKILDKQKVVKLKQIEHTLNEKRILQAVNFPFLVKLEFSFKDNSNLYMVMEYVPGGEMFSHLRRIGRFSEPHARFYAAQIVLTFEYLHSLDLIYRDLKPENLLIDQQGYIQVTDFGFAKRVKGRTWTLCGTPEYLAPEIILSKGYNKAVDWWALGVLIYEMAAGYPPFFADQPIQIYEKIVSGKVRFPSHFSSDLKDLLRNLLQVDLTKRFGNLKNGVNDIKNHKWF"]

# P53602_S96_LARKRRNSRDGDPLP listed first and Q01831_T169_PVEIEIETPEQAKTR listed second
substrates=["LARKRRNSRDGDPLP","PVEIEIETPEQAKTR"]


def phosST(kinaseDomainSeqs,substrate15mers):
    job = run_model(
        substrate15mers,
        kinaseDomainSeqs,
        model=model, 
        tokenizer=tokenizer, 
        device='cuda', 
        batch_size=10,
        output_hidden_states=False,
        output_attentions=False,
    )
    
    #total = dataset.shape[0]
    results = {
        'kinase' : [],
        'peptide' : [],
        'prob' : [],
    }
    
    for n, i in enumerate(job):
        #sys.stderr.write(f'{n+1} / {total}\r')
        results['kinase' ] += [i['kinase']]
        results['peptide'] += [i['peptide']]
        results['prob'   ] += [i['probability']]
    
    result = pd.DataFrame(results)

    return result



phosST(kinDomains,substrates).to_csv('BatchExample.csv')




```
</br>

</br>

## Troubleshooting

If torch is not installing correctly or you do not have a GPU to run Phos-ST on, the CPU version of torch is perfectly fine to use

Using the CPU version of torch might 10x to 1000x your run time so for large prediction datasets GPU acceleration is suggested

If you just are here to test if it phos-ST works, the example code should not take to much time to run on the CPU version of torch  

Also depending on your GPU the `batch_size` argument might need to be adjusted


 
